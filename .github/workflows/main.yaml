name: Run Podman Compose demos

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'

  workflow_dispatch:

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    env:
      TMPDIR: /tmp
      XDG_RUNTIME_DIR: /tmp/podman-run

    steps:
      # --------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2Ô∏è‚É£ Install Podman & podman-compose
      # --------------------------------------------------
      - name: Install Podman & podman-compose
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman python3-pip uidmap
          pip install --upgrade pip
          pip install podman-compose
          podman --version

      # --------------------------------------------------
      # 3Ô∏è‚É£ Configure Podman runtime (CRITICAL FIX)
      # --------------------------------------------------
      - name: Configure Podman runtime (cgroupfs)
        run: |
          mkdir -p ~/.config/containers
          cat <<EOF > ~/.config/containers/containers.conf
          [engine]
          cgroup_manager = "cgroupfs"
          runtime = "crun"
          EOF

          mkdir -p $XDG_RUNTIME_DIR
          chmod 700 $XDG_RUNTIME_DIR

          podman info | grep -i cgroup

      # --------------------------------------------------
      # 4Ô∏è‚É£ Configure Podman storage (avoid disk full)
      # --------------------------------------------------
      - name: Configure Podman storage
        run: |
          STORAGE_ROOT="/home/runner/work/_containers"
          sudo mkdir -p "$STORAGE_ROOT" /etc/containers

          cat <<EOF | sudo tee /etc/containers/storage.conf
          [storage]
          driver = "overlay"
          graphroot = "$STORAGE_ROOT"
          runroot = "/tmp/podman-runroot"
          EOF

          podman system migrate

      # --------------------------------------------------
      # 5Ô∏è‚É£ Pre-cleanup (important for CI stability)
      # --------------------------------------------------
      - name: Pre-build cleanup
        run: |
          podman ps -aq | xargs -r podman stop || true
          podman ps -aq | xargs -r podman rm -f || true
          podman images -aq | xargs -r podman rmi -f || true
          podman volume prune -f || true
          podman network prune -f || true
          podman system prune -a -f || true

      # --------------------------------------------------
      # 6Ô∏è‚É£ Create required Podman network
      # --------------------------------------------------
      - name: Create Podman network
        run: |
          podman network exists anomaly-network || \
          podman network create anomaly-network

      # --------------------------------------------------
      # 7Ô∏è‚É£ Build & Run demo-1-basics
      # --------------------------------------------------
      - name: Run demo-1-basics
        working-directory: demo/demo-1-basics
        run: |
          echo "Running demo-1-basics..."
          podman-compose build
          podman-compose up -d

          podman ps -a
          podman-compose logs || true

          podman-compose down -v

      # --------------------------------------------------
      # 8Ô∏è‚É£ Cleanup between demos (VERY IMPORTANT)
      # --------------------------------------------------
      - name: Cleanup between demos
        run: |
          podman system prune -a -f
          podman network prune -f || true

      # --------------------------------------------------
      # 9Ô∏è‚É£ Re-create network for next demo
      # --------------------------------------------------
      - name: Re-create Podman network
        run: |
          podman network exists anomaly-network || \
          podman network create anomaly-network

      # --------------------------------------------------
      # üîü Build & Run demo-2-otel
      # --------------------------------------------------
      - name: Run demo-2-otel
        working-directory: demo/demo-2-otel
        run: |
          echo "Running demo-2-otel..."
          podman-compose build
          podman-compose up -d

          podman ps -a
          podman-compose logs || true

          podman-compose down -v

      # --------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Final cleanup
      # --------------------------------------------------
      - name: Final cleanup
        if: always()
        run: |
          podman system prune -a -f
          podman network prune -f || true
