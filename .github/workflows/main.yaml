name: Run Podman Compose for demo-1-basics and demo-2-otel

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  workflow_dispatch:

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Skip README-only changes
      # --------------------------------------------------
      - name: Check for README.md only changes
        id: check_readme_only
        run: |
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files: $CHANGED_FILES"

          for file in $CHANGED_FILES; do
            if [[ "$file" != *README.md ]]; then
              echo "run=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "run=false" >> $GITHUB_OUTPUT

      - name: Abort if only README.md changed
        if: steps.check_readme_only.outputs.run == 'false'
        run: |
          echo "Only README.md files changed; skipping job"
          exit 0

      # --------------------------------------------------
      # Install Podman
      # --------------------------------------------------
      - name: Install Podman & podman-compose
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman python3-pip
          pip install podman-compose
          podman --version
          podman-compose --version

      # --------------------------------------------------
      # ðŸ”´ CRITICAL FIX #1: Podman storage + TMPDIR
      # --------------------------------------------------
      - name: Configure Podman storage and temp dirs
        run: |
          STORAGE_ROOT="/home/runner/work/podman-storage"
          TMP_ROOT="/home/runner/work/podman-tmp"

          sudo mkdir -p "$STORAGE_ROOT" "$TMP_ROOT" /etc/containers

          echo "[storage]" | sudo tee /etc/containers/storage.conf
          echo "driver = \"overlay\"" | sudo tee -a /etc/containers/storage.conf
          echo "graphroot = \"$STORAGE_ROOT\"" | sudo tee -a /etc/containers/storage.conf
          echo "runroot = \"$TMP_ROOT\"" | sudo tee -a /etc/containers/storage.conf

          echo "TMPDIR=$TMP_ROOT" >> $GITHUB_ENV
          echo "XDG_RUNTIME_DIR=$TMP_ROOT" >> $GITHUB_ENV

          podman system migrate || true

      # --------------------------------------------------
      # Cleanup before builds
      # --------------------------------------------------
      - name: Pre-build Cleanup
        run: |
          podman ps -aq | xargs -r podman stop
          podman ps -aq | xargs -r podman rm -f
          podman images -aq | xargs -r podman rmi -f
          podman volume prune -f
          podman network prune -f
          podman system prune -a -f

      # --------------------------------------------------
      # Create external networks
      # --------------------------------------------------
      - name: Create Podman networks
        run: |
          podman network exists anomaly-network || podman network create anomaly-network
          podman network exists otel-network || podman network create otel-network

      # --------------------------------------------------
      # demo-1-basics
      # --------------------------------------------------
      - name: Build & Run demo-1-basics
        working-directory: demo/demo-1-basics
        run: |
          echo "Running demo-1-basics..."

          podman-compose -f docker-compose.yaml build
          podman-compose -f docker-compose.yaml up -d

          podman ps -a
          podman-compose -f docker-compose.yaml logs || true

          podman-compose -f docker-compose.yaml down -v

      # --------------------------------------------------
      # ðŸ”´ CRITICAL FIX #3: prune between demos
      # --------------------------------------------------
      - name: Cleanup after demo-1-basics
        run: |
          podman system prune -a -f

      # --------------------------------------------------
      # demo-2-otel
      # --------------------------------------------------
      - name: Build & Run demo-2-otel
        working-directory: demo/demo-2-otel
        run: |
          echo "Running demo-2-otel..."

          podman-compose -f docker-compose.yaml build
          podman-compose -f docker-compose.yaml up -d

          podman ps -a
          podman-compose -f docker-compose.yaml logs || true

          podman-compose -f docker-compose.yaml down -v

      # --------------------------------------------------
      # Final cleanup
      # --------------------------------------------------
      - name: Final Cleanup
        if: always()
        run: |
          podman system prune -a -f
