name: Run Podman Compose for demo-1-basics and demo-2-otel

on:
  push:
    branches: [ main ]
    paths:
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  pull_request:
    paths:
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for README.md only changes
        id: check_readme_only
        run: |
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files: $CHANGED_FILES"
          for file in $CHANGED_FILES; do
            if [[ "$file" != *README.md ]]; then
              echo "Non-README file changed"
              echo "run=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "run=false" >> $GITHUB_OUTPUT

      - name: Abort if only README.md changed
        if: steps.check_readme_only.outputs.run == 'false'
        run: |
          echo "Only README.md files changed; skipping job"
          exit 0

      - name: Install Podman & podman-compose
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman python3-pip
          pip install podman-compose
          podman --version

      - name: Configure Podman storage
        run: |
          STORAGE_ROOT="/home/runner/work/_containers"
          sudo mkdir -p "$STORAGE_ROOT" /etc/containers

          echo "[storage]" | sudo tee /etc/containers/storage.conf
          echo "graphroot=\"$STORAGE_ROOT\"" | sudo tee -a /etc/containers/storage.conf

          podman system migrate

      - name: Pre-build Cleanup
        run: |
          podman ps -aq | xargs -r podman stop
          podman ps -aq | xargs -r podman rm -f
          podman images -aq | xargs -r podman rmi -f
          podman volume prune -f
          podman network prune -f
          podman system prune -a -f

      - name: Build & Run demo-1-basics
        working-directory: demo/demo-1-basics
        run: |
          echo "Building and running demo-1-basics..."
          podman-compose build --no-cache
          podman-compose up -d

          echo "Containers for demo-1-basics:"
          podman ps -a

          podman-compose logs || true

          echo "Cleaning up demo-1-basics..."
          podman-compose down -v

      - name: Build & Run demo-2-otel
        working-directory: demo/demo-2-otel
        run: |
          echo "Building and running demo-2-otel..."
          podman-compose build --no-cache
          podman-compose up -d

          echo "Containers for demo-2-otel:"
          podman ps -a

          podman-compose logs || true

          echo "Cleaning up demo-2-otel..."
          podman-compose down -v

      - name: Final Cleanup
        if: always()
        run: |
          echo "Final Podman system cleanup..."
          podman system prune -a -f
