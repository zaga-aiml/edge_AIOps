name: Run Podman Compose (Clean Sequential Build)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - README.md
      - "**/README.md"
  pull_request:
    paths-ignore:
      - README.md
      - "**/README.md"

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2Ô∏è‚É£ Install Podman & podman-compose
      # -------------------------------------------------
      - name: Install Podman
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman python3-pip
          pip install podman-compose
          podman --version

      # -------------------------------------------------
      # 3Ô∏è‚É£ Configure Podman storage
      # -------------------------------------------------
      - name: Configure Podman storage
        run: |
          STORAGE_ROOT="/home/runner/work/_containers"
          sudo mkdir -p "$STORAGE_ROOT" /etc/containers

          echo "[storage]" | sudo tee /etc/containers/storage.conf
          echo "graphroot=\"$STORAGE_ROOT\"" | sudo tee -a /etc/containers/storage.conf

          podman system migrate

      # -------------------------------------------------
      # 4Ô∏è‚É£ Global pre-clean (safety)
      # -------------------------------------------------
      - name: Pre-build Cleanup
        run: |
          podman ps -aq | xargs -r podman stop
          podman ps -aq | xargs -r podman rm -f
          podman images -aq | xargs -r podman rmi -f
          podman volume prune -f
          podman network prune -f
          podman system prune -a -f

      # =================================================
      # DEMO
      # =================================================
      - name: Build & Run Demo
        working-directory: demo
        run: |
          echo "Running demo..."
          podman-compose -p demo build --no-cache
          podman-compose -p demo up -d

          echo "Containers:"
          podman ps

          echo "Logs:"
          podman-compose -p demo logs

          echo "Cleanup demo..."
          podman-compose -p demo down -v

      # =================================================
      # DEMO-1
      # =================================================
      - name: Build & Run Demo-1
        working-directory: demo-1-basics
        run: |
          echo "Running demo-1..."
          podman-compose -p demo1 build --no-cache
          podman-compose -p demo1 up -d

          echo "All containers (including exited):"
          podman ps -a

          echo "Compose logs:"
          podman-compose -p demo1 logs --no-color || true

          echo "Cleanup Demo-1..."
          podman-compose -p demo1 down -v

      # =================================================
      # DEMO-2
      # =================================================
      - name: Build & Run Demo-2
        working-directory: demo-2-otel
        run: |
          echo "Running demo-2..."
          podman-compose -p demo2 build --no-cache
          podman-compose -p demo2 up -d

          echo "Containers:"
          podman ps

          echo "Logs:"
          podman-compose -p demo2 logs

          echo "Cleanup demo-2..."
          podman-compose -p demo2 down -v

      # -------------------------------------------------
      # üîü FINAL CLEANUP (always)
      # -------------------------------------------------
      - name: Final Cleanup
        if: always()
        run: |
          echo "Final Podman cleanup..."
          podman system prune -a -f