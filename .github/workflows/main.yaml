name: Run Podman Compose demos

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'demo/demo-1-basics/**'
      - 'demo/demo-2-otel/**'
  workflow_dispatch:

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    env:
      # ‚úÖ MUST be user-owned paths
      XDG_RUNTIME_DIR: ${{ github.workspace }}/podman-runtime
      TMPDIR: ${{ github.workspace }}/podman-tmp
      PODMAN_STORAGE: ${{ github.workspace }}/podman-storage

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2Ô∏è‚É£ Free disk space (CRITICAL)
    # --------------------------------------------------
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo docker image prune -a -f || true
        df -h

    # --------------------------------------------------
    # 3Ô∏è‚É£ Install Podman & podman-compose
    # --------------------------------------------------
    - name: Install Podman & podman-compose
      run: |
        sudo apt-get update -y
        sudo apt-get install -y podman uidmap python3-pip
        pip install --upgrade pip
        pip install podman-compose
        podman --version
        podman-compose --version

    # --------------------------------------------------
    # 4Ô∏è‚É£ Configure Podman runtime (NO systemd)
    # --------------------------------------------------
    - name: Configure Podman runtime
      run: |
        mkdir -p ~/.config/containers
        cat <<EOF > ~/.config/containers/containers.conf
        [engine]
        cgroup_manager = "cgroupfs"
        runtime = "crun"
        events_logger = "file"
        EOF

    # --------------------------------------------------
    # 5Ô∏è‚É£ Configure Podman storage + runtime dirs
    # --------------------------------------------------
    - name: Configure Podman storage
      run: |
        mkdir -p "$XDG_RUNTIME_DIR" "$TMPDIR" "$PODMAN_STORAGE"
        chmod 700 "$XDG_RUNTIME_DIR"
        chmod 777 "$TMPDIR" "$PODMAN_STORAGE"

        mkdir -p ~/.config/containers
        cat <<EOF > ~/.config/containers/storage.conf
        [storage]
        driver = "overlay"
        graphroot = "$PODMAN_STORAGE"
        runroot = "$XDG_RUNTIME_DIR/runroot"
        EOF

        podman system migrate
        podman info

    # --------------------------------------------------
    # 6Ô∏è‚É£ Hard cleanup before builds
    # --------------------------------------------------
    - name: Pre-build cleanup
      run: |
        podman ps -aq | xargs -r podman rm -f || true
        podman images -aq | xargs -r podman rmi -f || true
        podman volume prune -f || true
        podman network prune -f || true
        podman system prune -a -f || true

    # --------------------------------------------------
    # 7Ô∏è‚É£ Create shared network
    # --------------------------------------------------
    - name: Create Podman network
      run: |
        podman network exists anomaly-network || \
        podman network create anomaly-network

    # --------------------------------------------------
    # 8Ô∏è‚É£ demo-1-basics
    # --------------------------------------------------
    - name: Run demo-1-basics
      working-directory: demo/demo-1-basics
      run: |
        echo "Running demo-1-basics..."
        podman-compose build --no-cache
        podman-compose up -d

        podman ps -a
        podman-compose logs || true

        podman-compose down -v

    # --------------------------------------------------
    # 9Ô∏è‚É£ Cleanup between demos (MANDATORY)
    # --------------------------------------------------
    - name: Cleanup between demos
      run: |
        podman system prune -a -f
        podman volume prune -f || true
        podman network prune -f || true

    # --------------------------------------------------
    # üîü Re-create network
    # --------------------------------------------------
    - name: Re-create Podman network
      run: |
        podman network exists anomaly-network || \
        podman network create anomaly-network

    # --------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ demo-2-otel
    # --------------------------------------------------
    - name: Run demo-2-otel
      working-directory: demo/demo-2-otel
      run: |
        echo "Running demo-2-otel..."
        podman-compose build --no-cache
        podman-compose up -d

        podman ps -a
        podman-compose logs || true

        podman-compose down -v

    # --------------------------------------------------
    # 1Ô∏è‚É£2Ô∏è‚É£ Final cleanup
    # --------------------------------------------------
    - name: Final cleanup
      if: always()
      run: |
        podman system prune -a -f
        podman network prune -f || true
        df -h
