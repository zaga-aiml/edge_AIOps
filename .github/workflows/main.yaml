name: Run Podman Compose (Clean Sequential Build)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - README.md
      - "**/README.md"
  pull_request:
    paths-ignore:
      - README.md
      - "**/README.md"

jobs:
  podman-compose:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2Ô∏è‚É£ Install Podman & podman-compose
      # -------------------------------------------------
      - name: Install Podman
        run: |
          sudo apt-get update -y
          sudo apt-get install -y podman python3-pip
          pip3 install --user podman-compose
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          podman --version
          podman-compose --version

      # -------------------------------------------------
      # 3Ô∏è‚É£ Configure Podman storage (ROOTLESS & CI SAFE)
      # -------------------------------------------------
      - name: Configure Podman storage
        run: |
          mkdir -p ~/.config/containers ~/.local/share/containers

          cat <<EOF > ~/.config/containers/storage.conf
          [storage]
          driver = "overlay"
          graphroot = "$HOME/.local/share/containers"
          EOF

          podman system migrate || true

      # -------------------------------------------------
      # 4Ô∏è‚É£ Global pre-clean
      # -------------------------------------------------
      - name: Pre-build Cleanup
        run: |
          podman ps -aq | xargs -r podman rm -f
          podman images -aq | xargs -r podman rmi -f
          podman system prune -a -f

  

      # =================================================
      # DEMO-1-BASICS
      # =================================================
      - name: Build & Run demo-1-basics
        working-directory: demo-1-basics
        run: |
          echo "Running demo-1-basics..."
          podman-compose -p demo1 build --no-cache
          podman-compose -p demo1 up -d

          podman ps -a
          podman-compose -p demo1 logs --no-color || true

          podman-compose -p demo1 down -v

      - name: Debug compose context
        working-directory: demo-1-basics
        run: |
          pwd
          ls -la


      # =================================================
      # DEMO-2-OTEL
      # =================================================
      - name: Build & Run demo-2-otel
        working-directory: demo-2-otel
        run: |
          echo "Running demo-2-otel..."
          podman-compose -p demo2 build --no-cache
          podman-compose -p demo2 up -d

          podman ps
          podman-compose -p demo2 logs --no-color

          podman-compose -p demo2 down -v

      # -------------------------------------------------
      # üîü FINAL CLEANUP (always)
      # -------------------------------------------------
      - name: Final Cleanup
        if: always()
        run: |
          podman system prune -a -f
